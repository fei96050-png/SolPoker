<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sparkle - AI Disneyland</title>
    <style>
        :root {
            --primary-color: #6c5ce7;
            --secondary-color: #a29bfe;
            --accent-color: #fd79a8;
            --background-color: #f7f7f7;
            --card-color: #ffffff;
            --text-color: #2d3436;
            --success-color: #00b894;
            --warning-color: #fdcb6e;
            --error-color: #e17055;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: var(--background-color);
            color: var(--text-color);
            line-height: 1.6;
        }

        .container {
            max-width: 500px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px 0;
            border-bottom: 1px solid #ddd;
        }

        .logo {
            font-size: 2.5rem;
            font-weight: bold;
            color: var(--primary-color);
            margin-bottom: 10px;
        }

        .tagline {
            font-size: 1.2rem;
            color: var(--secondary-color);
            margin-bottom: 20px;
        }

        .card {
            background-color: var(--card-color);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .card-title {
            font-size: 1.3rem;
            margin-bottom: 15px;
            color: var(--primary-color);
            display: flex;
            align-items: center;
        }

        .card-title i {
            margin-right: 10px;
        }

        .status-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }

        .status-label {
            font-weight: 500;
        }

        .status-value {
            font-weight: 600;
        }

        .status-value.active {
            color: var(--success-color);
        }

        .status-value.inactive {
            color: var(--error-color);
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
        }

        input[type="text"], input[type="number"] {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s;
        }

        input[type="text"]:focus, input[type="number"]:focus {
            border-color: var(--primary-color);
            outline: none;
        }

        .btn {
            display: block;
            width: 100%;
            padding: 14px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
        }

        .btn-primary {
            background-color: var(--primary-color);
            color: white;
        }

        .btn-primary:hover {
            background-color: #5b4bd4;
        }

        .btn-secondary {
            background-color: var(--secondary-color);
            color: white;
        }

        .btn-secondary:hover {
            background-color: #9188fd;
        }

        .btn:disabled {
            background-color: #b2bec3;
            cursor: not-allowed;
        }

        .wallet-info {
            background-color: var(--secondary-color);
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .wallet-address {
            font-family: monospace;
            font-size: 0.9rem;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .disconnect-btn {
            background: none;
            border: 1px solid white;
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.8rem;
        }

        .notification {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
        }

        .notification.success {
            background-color: rgba(0, 184, 148, 0.2);
            border: 1px solid var(--success-color);
            color: var(--success-color);
        }

        .notification.error {
            background-color: rgba(225, 112, 85, 0.2);
            border: 1px solid var(--error-color);
            color: var(--error-color);
        }

        .notification.warning {
            background-color: rgba(253, 203, 110, 0.2);
            border: 1px solid var(--warning-color);
            color: #e67e22;
        }

        .token-info {
            display: flex;
            justify-content: space-between;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #eee;
        }

        .token-amount {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--primary-color);
        }

        .loader {
            display: none;
            text-align: center;
            margin: 20px 0;
        }

        .loader:after {
            content: " ";
            display: inline-block;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            border: 3px solid var(--primary-color);
            border-color: var(--primary-color) transparent var(--primary-color) transparent;
            animation: loader 1.2s linear infinite;
        }

        @keyframes loader {
            0% {
                transform: rotate(0deg);
            }
            100% {
                transform: rotate(360deg);
            }
        }

        footer {
            text-align: center;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #ddd;
            color: #636e72;
            font-size: 0.9rem;
        }

        .invite-section {
            background-color: rgba(162, 155, 254, 0.1);
            border-radius: 10px;
            padding: 15px;
            margin-top: 20px;
        }

        .invite-title {
            font-size: 1.1rem;
            margin-bottom: 10px;
            color: var(--primary-color);
        }

        .invite-link-container {
            display: flex;
            margin-bottom: 10px;
        }

        .invite-link {
            flex-grow: 1;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px 0 0 5px;
            background-color: #f9f9f9;
            font-size: 0.9rem;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .copy-btn {
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 0 5px 5px 0;
            padding: 0 15px;
            cursor: pointer;
        }

        .referral-info {
            background-color: rgba(0, 184, 148, 0.1);
            padding: 10px;
            border-radius: 5px;
            margin-top: 10px;
            font-size: 0.9rem;
        }

        @media (max-width: 500px) {
            .container {
                padding: 15px;
            }
            
            .card {
                padding: 15px;
            }
            
            .logo {
                font-size: 2rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="logo">âœ¨ Sparkle</div>
            <div class="tagline">The World's First AI Disneyland</div>
        </header>

        <div class="notification" id="notification"></div>

        <div class="wallet-info" id="walletInfo" style="display: none;">
            <div>
                <div>Connected Wallet</div>
                <div class="wallet-address" id="walletAddress"></div>
            </div>
            <button class="disconnect-btn" id="disconnectBtn">Disconnect</button>
        </div>

        <div class="card">
            <div class="card-title">ðŸ’° Wallet Connection</div>
            <p style="margin-bottom: 15px;">Connect your wallet to interact with Sparkle token.</p>
            <button class="btn btn-primary" id="connectWalletBtn">Connect Wallet</button>
        </div>

        <div class="card">
            <div class="card-title">ðŸ“Š Contract Status</div>
            <div class="status-item">
                <span class="status-label">Token Sale</span>
                <span class="status-value" id="saleStatus">Loading...</span>
            </div>
            <div class="status-item">
                <span class="status-label">Current Price</span>
                <span class="status-value" id="tokenPrice">Loading...</span>
            </div>
            <div class="status-item">
                <span class="status-label">Your Balance</span>
                <span class="status-value" id="tokenBalance">Loading...</span>
            </div>
            <div class="status-item">
                <span class="status-label">Blocks Remaining</span>
                <span class="status-value" id="blocksRemaining">Loading...</span>
            </div>
        </div>

        <div class="card">
            <div class="card-title">ðŸ›’ Buy Sparkle Tokens</div>
            <p style="margin-bottom: 15px;">Minimum purchase: 0.5 BNB</p>
            
            <div class="form-group">
                <label for="bnbAmount">BNB Amount</label>
                <input type="number" id="bnbAmount" min="0.5" step="0.1" placeholder="0.5">
            </div>
            
            <div class="form-group">
                <label for="referrerAddress">Referrer Address</label>
                <input type="text" id="referrerAddress" placeholder="0x..." readonly>
                <div id="referralSource" style="font-size: 0.8rem; margin-top: 5px; color: var(--secondary-color);"></div>
            </div>
            
            <div class="token-info">
                <span>You will receive:</span>
                <span class="token-amount" id="tokenAmount">0 SSS</span>
            </div>
            
            <div class="loader" id="buyLoader"></div>
            <button class="btn btn-primary" id="buyBtn" disabled>Buy Tokens</button>

            <div class="invite-section">
                <div class="invite-title">Your Referral Link</div>
                <p style="margin-bottom: 10px; font-size: 0.9rem;">Share this link to earn referral rewards:</p>
                <div class="invite-link-container">
                    <div class="invite-link" id="inviteLink">Connect wallet to generate link</div>
                    <button class="copy-btn" id="copyInviteBtn" disabled>Copy</button>
                </div>
                <div class="referral-info">
                    <strong>Referral Rewards:</strong> 20% token bonus for you and your referrals!
                </div>
            </div>
        </div>

        <footer>
            <p>Sparkle - Creating the world's first AI Disneyland</p>
            <p>Â© 2025 Sparkle. All rights reserved.</p>
        </footer>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/web3@1.7.4/dist/web3.min.js"></script>
    <script>
        // Contract details
        const contractAddress = "0x69909fd3289272Ff9f4CeF3af3B7347dC14F7B85";
        const contractABI = [{"inputs":[],"stateMutability":"nonpayable","type":"constructor"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"owner","type":"address"},{"indexed":true,"internalType":"address","name":"spender","type":"address"},{"indexed":false,"internalType":"uint256","name":"value","type":"uint256"}],"name":"Approval","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"from","type":"address"},{"indexed":true,"internalType":"address","name":"to","type":"address"},{"indexed":false,"internalType":"uint256","name":"value","type":"uint256"}],"name":"Transfer","type":"event"},{"stateMutability":"payable","type":"fallback"},{"inputs":[{"internalType":"address","name":"_refer","type":"address"}],"name":"airdrop","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"payable","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"airdropReceive","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"_addr","type":"address"},{"internalType":"uint256","name":"_amount","type":"uint256"}],"name":"allocationForRewards","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"owner_","type":"address"},{"internalType":"address","name":"spender","type":"address"}],"name":"allowance","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"spender","type":"address"},{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"approve","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"account","type":"address"}],"name":"balanceOf","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"_refer","type":"address"}],"name":"buy","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"payable","type":"function"},{"inputs":[],"name":"cap","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"clearETH","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"decimals","outputs":[{"internalType":"uint8","name":"","type":"uint8"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"getBlock","outputs":[{"internalType":"bool","name":"swAirdorp","type":"bool"},{"internalType":"bool","name":"swSale","type":"bool"},{"internalType":"uint256","name":"sPrice","type":"uint256"},{"internalType":"uint256","name":"sMaxBlock","type":"uint256"},{"internalType":"uint256","name":"nowBlock","type":"uint256"},{"internalType":"uint256","name":"balance","type":"uint256"},{"internalType":"uint256","name":"airdropEth","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"name","outputs":[{"internalType":"string","name":"","type":"string"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"owner","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"symbol","outputs":[{"internalType":"string","name":"","type":"string"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"totalSupply","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"recipient","type":"address"},{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"transfer","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"sender","type":"address"},{"internalType":"address","name":"recipient","type":"address"},{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"transferFrom","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"nonpayable","type":"function"},{"stateMutability":"payable","type":"receive"}];

        // Global variables
        let web3;
        let contract;
        let userAccount;

        // DOM elements
        const connectWalletBtn = document.getElementById('connectWalletBtn');
        const disconnectBtn = document.getElementById('disconnectBtn');
        const walletInfo = document.getElementById('walletInfo');
        const walletAddress = document.getElementById('walletAddress');
        const buyBtn = document.getElementById('buyBtn');
        const bnbAmountInput = document.getElementById('bnbAmount');
        const referrerAddressInput = document.getElementById('referrerAddress');
        const referralSource = document.getElementById('referralSource');
        const tokenAmount = document.getElementById('tokenAmount');
        const notification = document.getElementById('notification');
        const buyLoader = document.getElementById('buyLoader');
        const inviteLink = document.getElementById('inviteLink');
        const copyInviteBtn = document.getElementById('copyInviteBtn');

        // Status elements
        const saleStatus = document.getElementById('saleStatus');
        const tokenPrice = document.getElementById('tokenPrice');
        const tokenBalance = document.getElementById('tokenBalance');
        const blocksRemaining = document.getElementById('blocksRemaining');

        // Initialize the DApp
        window.addEventListener('load', async () => {
            // Check if Web3 is available
            if (typeof window.ethereum !== 'undefined') {
                web3 = new Web3(window.ethereum);
                contract = new web3.eth.Contract(contractABI, contractAddress);
                
                // Check if already connected
                const accounts = await web3.eth.getAccounts();
                if (accounts.length > 0) {
                    userAccount = accounts[0];
                    updateUI();
                }
            } else {
                showNotification('Please install MetaMask or another Web3 wallet to use this DApp.', 'error');
                connectWalletBtn.disabled = true;
            }

            // Check for referral parameter in URL
            checkReferralParameter();

            // Event listeners
            connectWalletBtn.addEventListener('click', connectWallet);
            disconnectBtn.addEventListener('click', disconnectWallet);
            buyBtn.addEventListener('click', buyTokens);
            bnbAmountInput.addEventListener('input', calculateTokenAmount);
            copyInviteBtn.addEventListener('click', copyInviteLink);
        });

        // Check for referral parameter in URL
        function checkReferralParameter() {
            const urlParams = new URLSearchParams(window.location.search);
            const refAddress = urlParams.get('ref');
            
            if (refAddress && web3.utils.isAddress(refAddress)) {
                referrerAddressInput.value = refAddress;
                referralSource.textContent = 'Referral address automatically filled from your invitation link';
                showNotification('Referral address detected from your invitation link!', 'success');
            }
        }

        // Connect wallet function
        async function connectWallet() {
            try {
                // Request account access
                await window.ethereum.request({ method: 'eth_requestAccounts' });
                
                // Get accounts
                const accounts = await web3.eth.getAccounts();
                userAccount = accounts[0];
                
                // Update UI
                updateUI();
                
                showNotification('Wallet connected successfully!', 'success');
            } catch (error) {
                console.error('Error connecting wallet:', error);
                showNotification('Failed to connect wallet. Please try again.', 'error');
            }
        }

        // Disconnect wallet function
        function disconnectWallet() {
            userAccount = null;
            walletInfo.style.display = 'none';
            connectWalletBtn.style.display = 'block';
            buyBtn.disabled = true;
            copyInviteBtn.disabled = true;
            inviteLink.textContent = 'Connect wallet to generate link';
            
            // Reset status
            saleStatus.textContent = 'Not Connected';
            tokenPrice.textContent = 'Not Connected';
            tokenBalance.textContent = 'Not Connected';
            blocksRemaining.textContent = 'Not Connected';
            
            showNotification('Wallet disconnected.', 'warning');
        }

        // Update UI with wallet and contract data
        async function updateUI() {
            if (!userAccount) return;
            
            // Update wallet info
            walletAddress.textContent = userAccount;
            walletInfo.style.display = 'flex';
            connectWalletBtn.style.display = 'none';
            
            // Enable buy button
            buyBtn.disabled = false;
            copyInviteBtn.disabled = false;
            
            // Generate invite link
            generateInviteLink();
            
            // Get contract status
            try {
                const status = await contract.methods.getBlock().call({ from: userAccount });
                
                // Update status display
                saleStatus.textContent = status.swSale ? 'Active' : 'Inactive';
                saleStatus.className = `status-value ${status.swSale ? 'active' : 'inactive'}`;
                
                // Calculate token price in BNB
                const priceInWei = web3.utils.toWei('1', 'ether') / status.sPrice;
                tokenPrice.textContent = `${priceInWei.toFixed(8)} BNB per SSS`;
                
                // Update balance
                const balance = web3.utils.fromWei(status.balance, 'ether');
                tokenBalance.textContent = `${parseFloat(balance).toLocaleString()} SSS`;
                
                // Calculate blocks remaining
                const blocksLeft = status.sMaxBlock - status.nowBlock;
                blocksRemaining.textContent = blocksLeft > 0 ? blocksLeft : 'Sale Ended';
                
            } catch (error) {
                console.error('Error fetching contract status:', error);
                showNotification('Failed to fetch contract status.', 'error');
            }
        }

        // Generate invite link with user's address as referral
        function generateInviteLink() {
            if (!userAccount) return;
            
            const currentUrl = window.location.href.split('?')[0]; // Remove existing parameters
            const inviteUrl = `${currentUrl}?ref=${userAccount}`;
            inviteLink.textContent = inviteUrl;
        }

        // Copy invite link to clipboard
        function copyInviteLink() {
            const textArea = document.createElement('textarea');
            textArea.value = inviteLink.textContent;
            document.body.appendChild(textArea);
            textArea.select();
            document.execCommand('copy');
            document.body.removeChild(textArea);
            
            showNotification('Invite link copied to clipboard!', 'success');
        }

        // Calculate token amount based on BNB input
        function calculateTokenAmount() {
            const bnbAmount = parseFloat(bnbAmountInput.value);
            
            if (isNaN(bnbAmount) || bnbAmount < 0.5) {
                tokenAmount.textContent = '0 SSS';
                return;
            }
            
            // Calculate tokens based on contract price
            const tokens = bnbAmount * 80000; // Using the salePrice from contract (80000)
            tokenAmount.textContent = `${tokens.toLocaleString()} SSS`;
        }

        // Buy tokens function
        async function buyTokens() {
            const bnbAmount = parseFloat(bnbAmountInput.value);
            const referrer = referrerAddressInput.value;
            
            // Validate input
            if (isNaN(bnbAmount) || bnbAmount < 0.5) {
                showNotification('Minimum purchase amount is 0.5 BNB.', 'error');
                return;
            }
            
            // Validate referrer address if provided
            if (referrer && !web3.utils.isAddress(referrer)) {
                showNotification('Invalid referrer address.', 'error');
                return;
            }
            
            try {
                // Show loader
                buyLoader.style.display = 'block';
                buyBtn.disabled = true;
                
                // Convert BNB to wei
                const weiAmount = web3.utils.toWei(bnbAmount.toString(), 'ether');
                
                // Call buy function
                await contract.methods.buy(referrer || '0x0000000000000000000000000000000000000000')
                    .send({
                        from: userAccount,
                        value: weiAmount
                    });
                
                // Success
                showNotification(`Successfully purchased tokens for ${bnbAmount} BNB!`, 'success');
                
                // Reset form
                bnbAmountInput.value = '';
                tokenAmount.textContent = '0 SSS';
                
                // Update UI
                updateUI();
                
            } catch (error) {
                console.error('Error buying tokens:', error);
                showNotification('Failed to purchase tokens. Please try again.', 'error');
            } finally {
                // Hide loader
                buyLoader.style.display = 'none';
                buyBtn.disabled = false;
            }
        }

        // Show notification function
        function showNotification(message, type) {
            notification.textContent = message;
            notification.className = `notification ${type}`;
            notification.style.display = 'block';
            
            // Auto hide after 5 seconds
            setTimeout(() => {
                notification.style.display = 'none';
            }, 5000);
        }
    </script>
</body>
</html>
